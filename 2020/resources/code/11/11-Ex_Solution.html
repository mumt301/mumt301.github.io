<html>
    <head>
        <title>Last.FM API call</title>
        <link rel="stylesheet" href="https://minicss.org/flavorFiles/mini-default.css">
        <!-- <link rel="stylesheet" href="https://minicss.org/flavorFiles/mini-dark.css"> -->
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <style>
            .image-pad {
                float: left;
                padding-top: 5px;
                padding-right: 50px;
                padding-bottom: 30px;
                padding-left: 0px;
            }
        </style>
    </head>
    <body>
        <h1>Type the name of an artist you love.</h1>
        <form id="queryForm">
            <label for="artist">Artist name:</label>
            <input type="text" name="artistName" id="artist">
            <input type="submit">
        </form>

        <!-- Placeholder -->
        <div id="bioContainer"></div>

        <script>
            const apiKey = "1dc26bf16ff2c65243d5092a16042679";    // Martha's key
            //apiKey = "4d33f33e040ed32486d12d93658710f7";  // Gabriel's

            function queryCall() {
                // Getting artist name from form
                let params = (new URL(document.location)).searchParams;
                    if (params.has('artistName')) {
                        let artistName = params.get('artistName');
                        console.log(artistName);

                        // Creating the API call

                        // A. Crafting the message
                        let queryURL = "https://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist=" + artistName + "&api_key=" + apiKey;
                        console.log(queryURL);
                        
                        // B. Sending the request
                        httpGet(queryURL, getBioAndImage);
                    }
            }
        
            function httpGet(theUrl, cbFunction, parameters) {
                // Creates a new XMLHttpRequest object
                let xmlHttp = new XMLHttpRequest();
                // Specifies the request method and URL, and sends the request to the server
                xmlHttp.open("GET", theUrl);
                xmlHttp.send();

                // Wait for response to be ready and store it in a variable
                xmlHttp.onreadystatechange = function() {
                    // Defines a function to be called when the readyState property changes
                    if (this.readyState == 4 && this.status == 200) {
                        // when the response is ready, then call the callback function to parse the response and render the corresponding results
                        cbFunction(this, parameters);
                    };
                }
            }

            function getBioAndImage(xhttp) {

                // Store response in a variable
                let retrievedData = xhttp.responseXML;

                // Parse the response
                let artistMBID = retrievedData.getElementsByTagName("mbid")[0].innerHTML;

                let bioContent = retrievedData.getElementsByTagName("content")[0].innerHTML;

                // Creating the API call

                // A. Crafting the message
                let queryURL2 = "https://ws.audioscrobbler.com/2.0/?method=artist.gettopalbums&mbid=" + artistMBID + "&api_key=" + apiKey;
                console.log(queryURL2);

                // B. Sending the request
                httpGet(queryURL2, getImage, bioContent);
            }

            function getImage(xhttp, bioContent) {

                // Store response in a variable
                let retrievedData2 = xhttp.responseXML;

                // Parse the response
                let imageURL = retrievedData2.getElementsByTagName("image")[3].innerHTML;

                // Append the results to the DOM
                let bio = document.createElement("p");
                bio.innerHTML = bioContent;

                let image = document.createElement("img");
                image.src = imageURL;
                image.classList.add("image-pad"); // Text around image

                let infobox = document.getElementById("bioContainer");
                infobox.appendChild(image);
                infobox.appendChild(bio);
            }

            window.onload = queryCall;
        </script>
    </body>
</html>
